# $(SYS) = The System (DG)
# EVR-01 = EVR name
# $(TSEVT,undefined) =  event letter that we get the time from
# $(SYNC_EVNT) = Event number to send timestamp

record(aSub, "$(SYS)-EVR-01:getTimeStamp_aSub"){
	field(SNAM, "getTimeStamp_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-EVR-01:$(TSEVT)-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "$(SYS)-EVR-01:FracNsecDelta-SP")
	field(FTVA, "LONG")
	field(NOVA, "1")
	field(OUTA, "$(SYS)-EVR-01:SyncSec-RBV PP")
	field(FTVB, "LONG")
	field(NOVB, "1")
	field(OUTB, "$(SYS)-EVR-01:SyncNsec-RBV PP")	
}


record(longout, "$(SYS)-EVR-01:FracNsecDelta-SP"){
	field(DESC, "delta in ticks")
	info(autosaveFields_pass0, "VAL")
	field(FLNK, "$(SYS)-EVR-01:Delta-SP_")
}

record(calc, "$(SYS)-EVR-01:Delta-SP_"){
	field(DESC, "delta in ns")
	field(INPA, "$(SYS)-EVR-01:FracNsecDelta-SP NPP")
	field(CALC, "B*1000000000/88052500")
	field(EGU, "ns")
}

record(longin, "$(SYS)-EVR-01:SyncSec-RBV") {
  field(DESC, "Timestamp value upper 32 bits")
  field(VAL, "0")
}

record(longin, "$(SYS)-EVR-01:SyncNsec-RBV") {
  field(DESC, "Timestamp value lower 32 bits")
  field(VAL, "0")
}


record(aSub, "$(SYS)-EVR-01:checkTimeStamp_aSub"){
	field(SNAM, "getTimeStamp_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-EVR-01:EvtG-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "0")
	field(FTVA, "LONG")
	field(NOVA, "1")
	field(OUTA, "$(SYS)-EVR-01:CheckSec-RBV PP")
	field(FTVB, "LONG")
	field(NOVB, "1")
	field(OUTB, "$(SYS)-EVR-01:CheckNsec-RBV PP")	
}

record(longin, "$(SYS)-EVR-01:CheckSec-RBV") {
  field(DESC, "Timestamp value upper 32 bits")
  field(VAL, "0")
}

record(longin, "$(SYS)-EVR-01:CheckNsec-RBV") {
  field(DESC, "Timestamp value lower 32 bits")
  field(VAL, "0")
}


record(bo, "$(SYS)-EVR-01:detSyncState-SP"){
	field(VAL, 	"1")
	field(ZNAM, "Initial Sync")
	field(ONAM, "Sync Check")
	field(FLNK, "$(SYS)-EVR-01:changeSyncState-CMD")
	field(SDIS, "$(SYS)-EVR-01:Time-Valid-Sts")
	field(DISV, "0")#if the time is not valid then disable the record processing
}

record(bi, "$(SYS)-EVR-01:detSyncState-RBV"){
	field(ZNAM, "Initial Sync")
	field(ONAM, "Sync Check")
}



record(longout, "$(SYS)-EVR-01:syncTrigEvt-SP"){
	field(DESC, "Event number for sequence")
	field(VAL, "$(SYNC_EVNT)")
}

record(seq, "$(SYS)-EVR-01:changeSyncState-CMD"){

	field(DOL1, "1")
	field(DOL2, "1")
	field(DOL3, "1")
	field(DOL4, "1")
	field(DOL5, "1")
	field(DOL6, "1")
	field(DOL7, "$(SYS)-EVR-01:detSyncState-SP")
	
	field(DLY2, "0.1")
	field(DLY3, "0.2")
	field(DLY4, "0.3")
	field(DLY5, "0.4")
	field(DLY6, "0.5")
	field(DLY7, "1.1")
	
	field(LNK1, "$(SYS)-EVR-01:SoftSeq0-Disable-Cmd PP")
	field(LNK2, "$(SYS)-EVR-01:SoftSeq0-Unload-Cmd PP")
	field(LNK3, "$(SYS)-EVR-01:SoftSeq0-Load-Cmd PP")
	field(LNK4, "$(SYS)-EVR-01:syncState_aSub.PROC")
	field(LNK5, "$(SYS)-EVR-01:SoftSeq0-Commit-Cmd PP")
	field(LNK6, "$(SYS)-EVR-01:SoftSeq0-Enable-Cmd PP")
	field(LNK7, "$(SYS)-EVR-01:detSyncState-RBV PP")

}





record(aSub, "$(SYS)-EVR-01:syncState_aSub"){
	field(SNAM, "syncState_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-EVR-01:detSyncState-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "$(SYS)-EVR-01:Evt-ResetPS-SP")
	field(FTC, 	"LONG")
	field(NOC, 	"1")
	field(INPC, "$(SYS)-EVR-01:syncTrigEvt-SP")
	field(FTD, 	"LONG")
	field(NOD, 	"1")
	field(INPD, "$(SYS)-EVR-01:FracNsecDelta-SP")
	field(FTVA, "FLOAT")
	field(NOVA, "4")
	field(OUTA, "$(SYS)-EVR-01:SoftSeq0-EvtCode-SP PP")
	field(FTVB, "DOUBLE")
	field(NOVB, "4")
	field(OUTB, "$(SYS)-EVR-01:SoftSeq0-Timestamp-SP PP")
	field(FTVC, "ENUM")
	field(NOVC, "1")
	field(OUTC, "$(SYS)-EVR-01:SoftSeq0-RunMode-Sel.VAL PP")
		
}
