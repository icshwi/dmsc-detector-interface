# $(SYS) = The System (DG)
# $(EVR) = EVR name
# $(TSEVT,undefined) =  event letter that we get the time from
# $(SYNC_EVNT) = Event number to send timestamp

record(aSub, "$(SYS)-$(EVR):getTimeStamp_aSub"){
	field(SNAM, "getTimeStamp_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-$(EVR):$(TSEVT)-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "$(SYS)-$(EVR):FracNsecDelta-SP")
	field(FTVA, "LONG")
	field(NOVA, "1")
	field(OUTA, "$(SYS)-$(EVR):SyncSec-RBV PP")
	field(FTVB, "LONG")
	field(NOVB, "1")
	field(OUTB, "$(SYS)-$(EVR):SyncNsec-RBV PP")	
}


record(longout, "$(SYS)-$(EVR):FracNsecDelta-SP"){
	field(DESC, "delta in nanos")
}

record(longin, "$(SYS)-$(EVR):SyncSec-RBV") {
  field(DESC, "Timestamp value upper 32 bits")
  field(VAL, "0")
}

record(longin, "$(SYS)-$(EVR):SyncNsec-RBV") {
  field(DESC, "Timestamp value lower 32 bits")
  field(VAL, "0")
}


record(aSub, "$(SYS)-$(EVR):checkTimeStamp_aSub"){
	field(SNAM, "getTimeStamp_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-$(EVR):EvtG-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "0")
	field(FTVA, "LONG")
	field(NOVA, "1")
	field(OUTA, "$(SYS)-$(EVR):CheckSec-RBV PP")
	field(FTVB, "LONG")
	field(NOVB, "1")
	field(OUTB, "$(SYS)-$(EVR):CheckNsec-RBV PP")	
}

record(longin, "$(SYS)-$(EVR):CheckSec-RBV") {
  field(DESC, "Timestamp value upper 32 bits")
  field(VAL, "0")
}

record(longin, "$(SYS)-$(EVR):CheckNsec-RBV") {
  field(DESC, "Timestamp value lower 32 bits")
  field(VAL, "0")
}


record(bo, "$(SYS)-$(EVR):detSyncState-SP"){
	field(VAL, 	"1")
	field(ZNAM, "Initial Sync")
	field(ONAM, "Sync Check")
	field(FLNK, "$(SYS)-$(EVR):changeSyncState-CMD")
	field(SDIS, "$(SYS)-$(EVR):Time-Valid-Sts")
	field(DISV, "0")#if the time is not valid then disable the record processing
}

record(bi, "$(SYS)-$(EVR):detSyncState-RBV"){
	field(ZNAM, "Initial Sync")
	field(ONAM, "Sync Check")
}



record(longout, "$(SYS)-$(EVR):syncTrigEvt-SP"){
	field(DESC, "Event number for sequence")
	field(VAL, "$(SYNC_EVNT)")
}

record(seq, "$(SYS)-$(EVR):changeSyncState-CMD"){

	field(DOL1, "1")
	field(DOL2, "1")
	field(DOL3, "1")
	field(DOL4, "1")
	field(DOL5, "1")
	field(DOL6, "1")
	field(DOL7, "$(SYS)-$(EVR):detSyncState-SP")
	
	field(DLY2, "0.1")
	field(DLY3, "0.2")
	field(DLY4, "0.3")
	field(DLY5, "0.4")
	field(DLY6, "0.5")
	field(DLY7, "1.1")
	
	field(LNK1, "$(SYS)-$(EVR):SoftSeq0-Disable-Cmd PP")
	field(LNK2, "$(SYS)-$(EVR):SoftSeq0-Unload-Cmd PP")
	field(LNK3, "$(SYS)-$(EVR):SoftSeq0-Load-Cmd PP")
	field(LNK4, "$(SYS)-$(EVR):syncState_aSub.PROC")
	field(LNK5, "$(SYS)-$(EVR):SoftSeq0-Commit-Cmd PP")
	field(LNK6, "$(SYS)-$(EVR):SoftSeq0-Enable-Cmd PP")
	field(LNK7, "$(SYS)-$(EVR):detSyncState-RBV PP")

}





record(aSub, "$(SYS)-$(EVR):syncState_aSub"){
	field(SNAM, "syncState_aSub")
	field(FTA,  "LONG")     
	field(NOA,  "1")  	
	field(INPA, "$(SYS)-$(EVR):detSyncState-SP")
	field(FTB,  "LONG")
	field(NOB,  "1")
	field(INPB, "$(SYS)-$(EVR):Evt-ResetPS-SP")
	field(FTC, 	"LONG")
	field(NOC, 	"1")
	field(INPC, "$(SYS)-$(EVR):syncTrigEvt-SP")
	field(FTD, 	"LONG")
	field(NOD, 	"1")
	field(INPD, "$(SYS)-$(EVR):FracNsecDelta-SP")
	field(FTVA, "FLOAT")
	field(NOVA, "4")
	field(OUTA, "$(SYS)-$(EVR):SoftSeq0-EvtCode-SP PP")
	field(FTVB, "DOUBLE")
	field(NOVB, "4")
	field(OUTB, "$(SYS)-$(EVR):SoftSeq0-Timestamp-SP PP")
	field(FTVC, "ENUM")
	field(NOVC, "1")
	field(OUTC, "$(SYS)-$(EVR):SoftSeq0-RunMode-Sel.VAL PP")
		
}
