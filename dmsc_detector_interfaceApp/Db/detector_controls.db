# Detector Controls general register read write
# $(SYS)    = The System (DG)
# $(DEV) = The Device name (FPGA)
# $(EVR) = EVR name
# $(COM) = COM port used for proto file
# $(PRO) = protocol file 
# $(SCAN_EVNT) = Event number that scans all RBVs
# $(CODE) = Event number to send timestamp



## Communication Records ###

record(bo, "$(SYS)-$(DEV):writeRegister"){

  field(DESC, "Send write Packets")
  field(DTYP, "stream")
  field(OUT, "@$(PRO) writeRegister($(SYS)-$(DEV),off,da) $(COM)")
  field(FLNK, "$(SYS)-$(DEV):registerRBV")
}

record(longin, "$(SYS)-$(DEV):registerRBV"){

  field(DESC, "Send packets to read  register")
  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(SYS)-$(DEV),off) $(COM)")
}


record(longin, "$(SYS)-$(DEV):off") {
  field(VAL, "0")
}


record(longin, "$(SYS)-$(DEV):da") {
# Add to getpvs
  field(DESC, "Data, 4 bytes")
  field(VAL, "0")
  
}

## Sync Timestamp Records ##

record (seq, "$(SYS)-$(DEV):syncTimestamp-CMD"){
	field(DESC, "Perform timestamp sync")
	field(DOL1, "1") #reset
	field(DOL2, "1") 
	field(DOL3, "0") #enable
	field(DOL4, "1")
	field(DLY2, "0.1")
	field(LNK1, "$(SYS)-$(DEV):RST-SP")
	field(LNK2, "$(SYS)-$(EVR):getTimeStamp_aSub.PROC")
	field(LNK3, "$(SYS)-$(DEV):RST-SP")
		
	field(LNK4, "$(SYS)-$(DEV):sendTim-CMD.PROC")
	field(SCAN, "Event")
	field(EVNT, "$(SYS)-$(EVR):syncTrigEvt-SP")
}


record(bo, "$(SYS)-$(DEV):sendTim-CMD") {
  field(DESC, "Send timestamp register packet to FPGA")
  field(DTYP, "stream")	
  field(OUT, "@$(PRO) sendTimestamp($(SYS)-$(EVR),SyncSec-RBV,SyncNsec-RBV) $(COM)")
}


## Check Timestamp Records ###

record (seq, "$(SYS)-$(DEV):checkTimestamp-CMD"){
	field(DESC, "Perform timestamp check")

	field(LNK1,  "$(SYS)-$(EVR):checkTimeStamp_aSub.PROC")	
	field(LNK2,  "$(SYS)-$(DEV):TSU-RBV.PROC")
	field(LNK3,  "$(SYS)-$(DEV):TSL-RBV.PROC")
	field(LNK4,  "$(SYS)-$(DEV):TS-SDiff-RBV.PROC")
	field(LNK5,  "$(SYS)-$(DEV):TS-NDiff-RBV.PROC")
	field(LNK6,  "$(SYS)-$(DEV):STATUS2-RBV.PROC")
	field(SCAN, "Event")
	field(EVNT, "$(SYS)-$(EVR):syncTrigEvt-SP")
}


record(calc, "$(SYS)-$(DEV):TS-SDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-$(EVR):CheckSec-RBV")
	field(INPB, "$(SYS)-$(DEV):TSU-RBV")
	field(CALC, "B-A")
	
}

record(calc, "$(SYS)-$(DEV):TS-NDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-$(EVR):CheckNsec-RBV")
	field(INPB, "$(SYS)-$(DEV):TSL-RBV")
	field(CALC, "B-A")
	
}




