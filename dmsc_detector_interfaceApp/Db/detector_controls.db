# Detector Controls general register read write
# $(SYS)    = The System (DG)
# $(DEV) = The Device name (FPGA)
# $(SFX)            = The PV Name Suffix
# $(COM) = COM port used for proto file
# $(PRO) = protocol file 

# $(REG0) = Timestamp lower register offset
# $(REG1) = Timestamp upper register offset

## Communication Records ###

	
record(bo, "$(SYS)-$(DEV):writeRegister"){

  field(DESC, "Send write Packets")
  field(DTYP, "stream")
  field(OUT, "@$(PRO) writeRegister($(SYS)-$(DEV),off,da) $(COM)")
  field(FLNK, "$(SYS)-$(DEV):registerRBV")
}

record(longin, "$(SYS)-$(DEV):registerRBV"){

  field(DESC, "Send packets to read  register")
  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(SYS)-$(DEV),off) $(COM)")
  field(PINI, "1")
}


record(longin, "$(SYS)-$(DEV):off") {
  field(VAL, "0")
  field(FLNK, "$(SYS)-$(DEV):registerRBV")
}


record(longin, "$(SYS)-$(DEV):da") {
  field(DESC, "Data, 4 bytes")
  field(VAL, "0")
  field(FLNK, "$(SYS)-$(DEV):registerRBV")
  
}

## Sync Timestamp Records ##

record (seq, "$(SYS)-$(DEV):syncTimestamp-CMD"){
	field(DESC, "Perform timestamp sync")
	field(LNK3, "$(SYS)-EVR-01:getTimeStamp_aSub.PROC")
	field(SCAN, "Event")
	field(EVNT, "15")
	field(FLNK, "$(SYS)-$(DEV):sendTim-CMD")
}


record(bo, "$(SYS)-$(DEV):sendTim-CMD") {
  field(DESC, "Send timestamp register packet to FPGA")
  field(DTYP, "stream")	
  field(OUT, "@$(PRO) sendTimestamp($(SYS)-EVR-01,SyncSec-RBV,SyncNsec-RBV) $(COM)")
  field(FLNK, "$(SYS)-$(DEV):RST-ENA-CMD")
}


## Check Timestamp Records ###

record (seq, "$(SYS)-$(DEV):checkTimestamp-CMD"){
	field(DESC, "Perform timestamp check")
	field(LNK1,  "$(SYS)-$(DEV):STATUS2-RBV.PROC")
	field(LNK2,  "$(SYS)-$(DEV):TSU-RBV.PROC")
	field(LNK3,  "$(SYS)-$(DEV):TSL-RBV.PROC")
	field(LNK4,  "$(SYS)-$(DEV):TS-Diff-RBV.PROC")
	field(LNK5,  "$(SYS)-$(DEV):TS-RBV.PROC")
	field(SCAN, "Event")
	field(EVNT, "16")
	field(DISV, "0")
	field(SDIS, "$(SYS)-EVR-01:detSyncState-SP NPP")
	
}



record(longin, "$(SYS)-$(DEV):TSU-RBV"){

  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(REG1)) $(COM)")
  field(PINI, "1")
  field(FLNK, "$(SYS)-$(DEV):TS-SDiff-RBV")
}

record(longin, "$(SYS)-$(DEV):TSL-RBV"){

  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(REG0)) $(COM)")
  field(PINI, "1")
  field(FLNK, "$(SYS)-$(DEV):TS-NDiff-RBV")
}

record(calc, "$(SYS)-$(DEV):TS-SDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-EVR-01:checkTimeStamp_aSub.VALA PP")
	#NPP since we've already worked out the value
	field(INPB, "$(SYS)-$(DEV):TSU-RBV NPP") 
	field(CALC, "B-A")
	
}

record(calc, "$(SYS)-$(DEV):TS-NDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-EVR-01:checkTimeStamp_aSub.VALB PP")
	#NPP since we've already worked out the value
	field(INPB, "$(SYS)-$(DEV):TSL-RBV NPP")
	field(CALC, "B-A")
	
}

record(calc, "$(SYS)-$(DEV):TS-Diff-RBV"){
	field(DESC, "Diff between ${DEV} and ${EVR} TS")
	field(INPA, "$(SYS)-$(DEV):TS-SDiff-RBV NPP")
	field(INPB, "$(SYS)-$(DEV):TS-NDiff-RBV NPP") 
	field(CALC, "(A+(B/88052500))*1000000000")
	field(EGU, "ns")
}

record(calc, "$(SYS)-$(DEV):TS-RBV"){
	field(DESC, "TS when pulse received")
	field(CALC, "A+(B*2/88052500)")
	field(INPA, "$(SYS)-$(DEV):TSU-RBV NPP") 
	field(INPB, "$(SYS)-$(DEV):TSL-RBV NPP")
	field(EGU, "S")
}

