# Detector Controls general register read write
# $(SYS)    = The System (DG)
# $(DEV) = The Device name (FPGA)
# $(EVR) = EVR name
# $(COM) = COM port used for proto file
# $(PRO) = protocol file 

# $(CLK_RST_EVNT) = Event number to send timestamp
# $(SYNC_EVNT) = Event number sync pulse is sent on and check is performed
# $(TSL-OFF) = Timestmap lower register offset
# $(TSU-OFF) = Timestmap upper register offset

## Communication Records ###

	
record(bo, "$(SYS)-$(DEV):writeRegister"){

  field(DESC, "Send write Packets")
  field(DTYP, "stream")
  field(OUT, "@$(PRO) writeRegister($(SYS)-$(DEV),off,da) $(COM)")
  field(FLNK, "$(SYS)-$(DEV):registerRBV")
}

record(longin, "$(SYS)-$(DEV):registerRBV"){

  field(DESC, "Send packets to read  register")
  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(SYS)-$(DEV),off) $(COM)")
}


record(longin, "$(SYS)-$(DEV):off") {
  field(VAL, "0")
  field(FLNK, "$(SYS)-$(DEV):writeRegister")
}


record(longin, "$(SYS)-$(DEV):da") {
  field(DESC, "Data, 4 bytes")
  field(VAL, "0")
  field(FLNK, "$(SYS)-$(DEV):writeRegister")
  
}

## Sync Timestamp Records ##

record (seq, "$(SYS)-$(DEV):syncTimestamp-CMD"){
	field(DESC, "Perform timestamp sync")
	field(LNK3, "$(SYS)-$(EVR):getTimeStamp_aSub.PROC")
	field(SCAN, "Event")
	field(EVNT, "$(CLK_RST_EVNT)")
	field(FLNK, "$(SYS)-$(DEV):sendTim-CMD")
}


record(bo, "$(SYS)-$(DEV):sendTim-CMD") {
  field(DESC, "Send timestamp register packet to FPGA")
  field(DTYP, "stream")	
  field(OUT, "@$(PRO) sendTimestamp($(SYS)-$(EVR),SyncSec-RBV,SyncNsec-RBV) $(COM)")
  field(FLNK, "$(SYS)-$(DEV):RST-ENA-CMD")
}


## Check Timestamp Records ###

record (seq, "$(SYS)-$(DEV):checkTimestamp-CMD"){
	field(DESC, "Perform timestamp check")
	field(LNK1,  "$(SYS)-$(DEV):STATUS2-RBV.PROC")
	field(LNK2,  "$(SYS)-$(DEV):TSU-RBV.PROC")
	field(LNK3,  "$(SYS)-$(DEV):TSL-RBV.PROC")
	field(SCAN, "Event")
	field(EVNT, "$(SYNC_EVNT)")
	field(DISV, "0")
	field(SDIS, "$(SYS)-$(EVR):detSyncState-SP NPP")
	
}

record(longin, "$(SYS)-$(DEV):TSU-OFF") {
  field(VAL, "$(TSU-OFF)")
}


record(longin, "$(SYS)-$(DEV):TSU-RBV"){

  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(SYS)-$(DEV),TSU-OFF) $(COM)")
  field(PINI, "1")
  field(FLNK, "$(SYS)-$(DEV):TS-SDiff-RBV")
}

record(longin, "$(SYS)-$(DEV):TSL-OFF") {
  field(VAL, "$(TSL-OFF)")
}


record(longin, "$(SYS)-$(DEV):TSL-RBV"){

  field(DTYP, "stream")
  field(INP, "@$(PRO) readRegister($(SYS)-$(DEV),TSL-OFF) $(COM)")
  field(PINI, "1")
  field(FLNK, "$(SYS)-$(DEV):TS-NDiff-RBV")
}

record(calc, "$(SYS)-$(DEV):TS-SDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-$(EVR):checkTimeStamp_aSub.VALA PP")
	#NPP since we've already worked out the value
	field(INPB, "$(SYS)-$(DEV):TSU-RBV NPP") 
	field(CALC, "B-A")
	
}

record(calc, "$(SYS)-$(DEV):TS-NDiff-RBV"){
	field(DESC, "Difference between ticks")
	field(INPA, "$(SYS)-$(EVR):checkTimeStamp_aSub.VALB PP")
	#NPP since we've already worked out the value
	field(INPB, "$(SYS)-$(DEV):TSL-RBV NPP")
	field(CALC, "B-A")
	
}
